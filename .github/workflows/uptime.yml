name: Website Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check-website:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Website Status, Notify Slack & Update status.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set +e

          DISPLAY_NAME="Cinepolis India"
          SITE_URL="https://cinepolis.com/uptime-health"
          PUBLIC_URL="https://cinepolis.com/in"
          TIMESTAMP=$(TZ="Asia/Kolkata" date "+%Y-%m-%d %H:%M:%S")

          ATTEMPTS=5
          FAIL_COUNT=0
          LAST_STATUS="000"
          HAS_403=0

          echo "Ultra Stable Monitor Started for $DISPLAY_NAME"

          for i in 1 2 3 4 5; do

            STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0 Safari/537.36" \
              --max-time 20 \
              "$SITE_URL")

            [ -z "$STATUS" ] && STATUS="000"
            LAST_STATUS="$STATUS"

            echo "Attempt $i => HTTP $STATUS"

            if [ "$STATUS" = "403" ]; then
              HAS_403=1
            fi

            if [ "$STATUS" = "000" ] || [ "$STATUS" -ge 500 ]; then
              FAIL_COUNT=$((FAIL_COUNT+1))
            fi

            sleep 3
          done

          STATE_TEXT="up"
          EMOJI="âœ…"
          NOTE="UP (stable)"

          if [ "$FAIL_COUNT" -ge 3 ]; then
            STATE_TEXT="down"
            EMOJI="ðŸš¨"
            NOTE="DOWN (confirmed)"
          elif [ "$HAS_403" -eq 1 ]; then
            EMOJI="ðŸŸ¡"
            NOTE="UP but Cloudflare restricted"
          fi

          MESSAGE="$EMOJI $DISPLAY_NAME Status

$NOTE
Public URL: $PUBLIC_URL
Backend URL: $SITE_URL
HTTP Code: $LAST_STATUS
Fails: $FAIL_COUNT / $ATTEMPTS
Time: $TIMESTAMP"

          # Slack send (safe)
          curl -X POST -H "Content-type: application/json" \
            --data "{\"text\":\"$(echo "$MESSAGE" | sed 's/"/\\"/g')\"}" \
            "$SLACK_WEBHOOK_URL"

          # Create status.json
          echo "{
            \"siteName\": \"$DISPLAY_NAME\",
            \"siteUrl\": \"$PUBLIC_URL\",
            \"backendUrl\": \"$SITE_URL\",
            \"status\": \"$STATE_TEXT\",
            \"httpCode\": \"$LAST_STATUS\",
            \"checkedAt\": \"$TIMESTAMP\",
            \"emoji\": \"$EMOJI\",
            \"note\": \"$NOTE\",
            \"fails\": $FAIL_COUNT,
            \"attempts\": $ATTEMPTS
          }" > status.json

      - name: Commit status.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json
          if git diff --cached --quiet; then
            echo "No change"
          else
            git commit -m "Stable status update"
            git push
          fi
