name: Website Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check-website:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # status.json commit karne ke liye

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Website Status, Notify Slack & Update status.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          SITE_URL="https://cinepolis.com/in"
          TIMESTAMP=$(TZ="Asia/Kolkata" date "+%Y-%m-%d %H:%M:%S")

          ATTEMPTS=5
          FAIL_COUNT=0
          LAST_STATUS="000"

          echo "Ultra-stable check for $SITE_URL at $TIMESTAMP"

          for i in $(seq 1 $ATTEMPTS); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --user-agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              --max-time 25 \
              --retry 2 \
              --retry-delay 5 \
              "$SITE_URL" || echo "000")

            LAST_STATUS="$STATUS"
            echo "Attempt $i => HTTP $STATUS"

            # â— Yahan pehle tumne -ge 400 kiya tha, isse 403 ko bhi DOWN maan raha tha
            # Ab standard rule:
            #  - 2xx, 3xx   => OK
            #  - 000, 5xx   => FAIL
            #  - 404 (optional) => FAIL
            if [ "$STATUS" = "000" ] || [ "$STATUS" -ge 500 ] || [ "$STATUS" -eq 404 ]; then
              FAIL_COUNT=$((FAIL_COUNT+1))
            fi

            # Last attempt ke baad sleep ki zaroorat nahi
            if [ "$i" -lt "$ATTEMPTS" ]; then
              sleep 5
            fi
          done

          echo "Total failures: $FAIL_COUNT / $ATTEMPTS"

          # Default: UP
          if [ "$FAIL_COUNT" -ge 3 ]; then
            STATE_TEXT="down"
            EMOJI="ðŸš¨"
            MESSAGE="ðŸš¨ Website DOWN (confirmed)
URL: $SITE_URL
Last HTTP: $LAST_STATUS
Fails: $FAIL_COUNT / $ATTEMPTS
Time: $TIMESTAMP"
          else
            STATE_TEXT="up"
            EMOJI="âœ…"
            # Yahan HTTP code clearly dikh raha hai, chahe 200 ho, 301 ho ya 403
            MESSAGE="âœ… Website UP (stable from monitor)
URL: $SITE_URL
Last HTTP: $LAST_STATUS
Fails: $FAIL_COUNT / $ATTEMPTS
Time: $TIMESTAMP"
          fi

          # ---- Slack Alert (same style as tumhara original) ----
          curl -X POST -H "Content-type: application/json" \
            --data "{\"text\":\"$MESSAGE\"}" \
            "$SLACK_WEBHOOK_URL"

          # ---- status.json generate (dashboard ke liye) ----
          printf '%s\n' \
            "{" \
            "  \"siteUrl\": \"$SITE_URL\"," \
            "  \"status\": \"$STATE_TEXT\"," \
            "  \"httpCode\": \"$LAST_STATUS\"," \
            "  \"checkedAt\": \"$TIMESTAMP\"," \
            "  \"emoji\": \"$EMOJI\"," \
            "  \"fails\": $FAIL_COUNT," \
            "  \"attempts\": $ATTEMPTS" \
            "}" > status.json

      - name: Commit status.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json
          if git diff --cached --quiet; then
            echo "No changes in status.json"
          else
            git commit -m "Update status.json"
            git push
          fi
